{{ partial "header.html" . }}

<!-- TOC toggle button (Hamburger Menu for mobile) -->
<div class="toc-toggle" onclick="toggleTOC()">â˜°</div>

<aside class="toc sticky">
  {{ .TableOfContents }}
</aside>

<div class="outer-wrapper">
  <!-- Main content container with header, title, and content -->
  <div class="body-container">
    <div class="article-meta">
      <h1><span class="title">{{ .Title | markdownify }}</span></h1>
      {{ if (gt .Params.date 0) }}<h2 class="date">{{ .Date.Format "2006/01/02" }}</h2>{{ end }}
    </div>

    <div class="content">
      {{ .Content }}
    </div>
  </div>
</div>

{{ partial "footer.html" . }}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tocLinks = document.querySelectorAll(".toc a");
    const sections = Array.from(tocLinks).map(link => document.querySelector(link.getAttribute("href")));
    const toc = document.querySelector('.toc');
    const tocToggle = document.querySelector('.toc-toggle');

    const observer = new IntersectionObserver(
      (entries) => {
        // Sort entries to find the one closest to the top of the viewport
        entries.sort((a, b) => a.intersectionRatio < b.intersectionRatio ? 1 : -1);

        for (const entry of entries) {
          const index = sections.indexOf(entry.target);
          if (entry.isIntersecting) {
            tocLinks.forEach((link) => link.classList.remove("active"));
            if (tocLinks[index]) tocLinks[index].classList.add("active");
            break; // Stop after highlighting the closest section
          }
        }
      },
      { rootMargin: "0px 0px -40% 0px", threshold: 0.75 } // Higher threshold to reduce flickering
    );

    sections.forEach((section) => observer.observe(section));

    // Extra check for bottom of page
    window.addEventListener("scroll", () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
        tocLinks.forEach((link) => link.classList.remove("active"));
        tocLinks[tocLinks.length - 1].classList.add("active"); // Highlight the last TOC item
      }
    });

    // Smooth scrolling for TOC links
    tocLinks.forEach(link => {
      link.addEventListener("click", function (e) {
        e.preventDefault();
        const targetId = this.getAttribute("href").substring(1);
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          window.scrollTo({
            top: targetElement.offsetTop - 20, // Adjust for any fixed headers
            behavior: "smooth"
          });
        }
      });
    });

    // Toggle TOC visibility for smaller screens
    tocToggle.addEventListener("click", () => {
      toc.classList.toggle('show');
    });
  });
</script>
